---
import Icon from '@components/Icon.astro';
---

<site-search-button class={Astro.props.class}>
  <button
    data-open-modal
    disabled
    aria-label={Astro.locals.t('search.label')}
    aria-keyshortcuts="Control+K"
  >
    <Icon name="search" size="sm" />
    <span class="md:sl-block" aria-hidden="true">{Astro.locals.t('search.label')}</span>
    <kbd class="md:sl-flex" style="display: none;">
      <kbd>{Astro.locals.t('search.ctrlKey')}</kbd><kbd>K</kbd>
    </kbd>
  </button>
</site-search-button>

<script is:inline>
  (() => {
    // Initialize all search buttons on the page
    document.addEventListener('DOMContentLoaded', () => {
      // Get all site-search-button elements
      const searchButtons = document.querySelectorAll('site-search-button');

      searchButtons.forEach((buttonContainer) => {
        const openBtn = buttonContainer.querySelector('button[data-open-modal]');
        const shortcut = openBtn?.querySelector('kbd');
        if (!openBtn || !(shortcut instanceof HTMLElement)) return;

        const platformKey = shortcut.querySelector('kbd');
        if (platformKey && /(Mac|iPhone|iPod|iPad)/i.test(navigator.userAgent)) {
          platformKey.textContent = 'âŒ˜';
          openBtn.setAttribute('aria-keyshortcuts', 'Meta+K');
        }
        shortcut.style.display = '';
      });
    });
  })();
</script>

<script>
  // Add event names to window object
  declare global {
    interface Window {
      SEARCH_MODAL_OPEN_EVENT: string;
      SEARCH_MODAL_CLOSE_EVENT: string;
    }
  }

  class SiteSearchButton extends HTMLElement {
    constructor() {
      super();
      const openBtn = this.querySelector<HTMLButtonElement>('button[data-open-modal]')!;

      // Wait for the SEARCH_MODAL_OPEN_EVENT to be defined
      window.addEventListener('DOMContentLoaded', () => {
        if (!window.SEARCH_MODAL_OPEN_EVENT) {
          console.warn('Search modal event not found. Make sure SearchModal is loaded.');
          return;
        }

        // Enable the button once the event is available
        openBtn.disabled = false;

        // Add click event listener to dispatch the custom event
        openBtn.addEventListener('click', (event) => {
          event.preventDefault();
          document.dispatchEvent(new CustomEvent(window.SEARCH_MODAL_OPEN_EVENT));
        });
      });
    }
  }

  customElements.define('site-search-button', SiteSearchButton);
</script>
