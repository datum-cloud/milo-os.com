---
import { remark } from 'remark';
import remarkHtml from 'remark-html';
import Button from '@components/Button.astro';
import Bullet from '@v1/assets/icons/bullet.svg';
import { changelogs, type ChangelogProps } from '@/src/libs/milo';

const calloutStyles: Record<string, { bg: string; text: string; icon: string }> = {
  note: { bg: 'bg-blue-100', text: 'text-blue-400', icon: 'â„¹' },
  warning: {
    bg: 'bg-yellow-100',
    text: 'text-yellow-700',
    icon: 'âš ï¸',
  },
  tip: { bg: 'bg-green-100', text: 'text-green-700', icon: 'ðŸ’¡' },
  important: {
    bg: 'bg-purple-100',
    text: 'text-purple-700',
    icon: 'â—',
  },
  caution: { bg: 'bg-red-100', text: 'text-red-700', icon: 'ðŸš¨' },
};

const processMarkdown = async (markdown: string) => {
  let processedHtml = await remark().use(remarkHtml, { sanitize: false }).process(markdown);
  let html = String(processedHtml);
  // Transform GitHub-style callouts: > [!NOTE], > [!WARNING], etc.
  const calloutRegex = /<p>\[!(NOTE|WARNING|TIP|IMPORTANT|CAUTION)\]([\s\S]*?)<\/p>/gi;

  html = html.replace(calloutRegex, (match, type, content) => {
    const calloutType = type.toLowerCase();
    const config = calloutStyles[calloutType] || calloutStyles.note;
    const title = type.charAt(0) + type.slice(1).toLowerCase();
    // return 'test';
    return `<div class="${config.text} mb-2" role="alert">
      ${config.icon} ${title}
      ${content.trim()}
    </div>`;
  });

  return html;
};

const changelogsEntries = await changelogs();
const limit = 3;
const entries = limit ? changelogsEntries.slice(0, limit) : changelogsEntries;
---

{
  entries.length > 0 && (
    <div id="changelog" class="section--block pt-16 xl:pt-28">
      <div class="section--block-inner max-w-306">
        <div class="display-card text-glacier-mist-700 bg-midnight-fjord border border-white rounded-[15px]">
          <div class="display-card--header">
            <h3>Changelog</h3>
          </div>
          <div class="display-card--content">
            <ul class="display-card--list display-card--timeline timeline-alt">
              {entries.map((entry: ChangelogProps) => async () => (
                <li class="display-card--item">
                  <div class="display-card--item-meta item-neta--timeline">
                    <Bullet class={limit ? 'text-aurora-moss' : 'text-canyon-clay'} />
                  </div>
                  <div
                    class={
                      limit
                        ? 'display-card--item-content text-white **:text-white'
                        : 'display-card--item-content'
                    }
                  >
                    <h4>{entry.title}</h4>
                    <div set:html={await processMarkdown(entry.body)} />
                  </div>
                </li>
              ))}
            </ul>

            <div>
              <Button
                text="View full Changelog"
                class="btn btn--aurora-moss"
                icon={{ name: 'arrow-right', size: 'md' }}
                iconPosition="right"
                iconClass="stroke-1.75"
                href="/changelog/"
              />
            </div>
          </div>
        </div>
      </div>
    </div>
  )
}
