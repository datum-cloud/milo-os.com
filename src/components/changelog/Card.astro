---
import { remark } from 'remark';
import remarkHtml from 'remark-html';
import Bullet from '@v1/assets/icons/bullet.svg';
import { changelogs, type ChangelogProps } from '@/src/libs/milo';

const calloutStyles: Record<string, { bg: string; text: string; icon: string }> = {
  note: { bg: 'bg-blue-100', text: 'text-blue-400', icon: 'â„¹' },
  warning: {
    bg: 'bg-yellow-100',
    text: 'text-yellow-700',
    icon: 'âš ï¸',
  },
  tip: { bg: 'bg-green-100', text: 'text-green-700', icon: 'ðŸ’¡' },
  important: {
    bg: 'bg-purple-100',
    text: 'text-purple-700',
    icon: 'â—',
  },
  caution: { bg: 'bg-red-100', text: 'text-red-700', icon: 'ðŸš¨' },
};

const processMarkdown = async (markdown: string) => {
  let processedHtml = await remark().use(remarkHtml, { sanitize: false }).process(markdown);
  let html = String(processedHtml);
  // Transform GitHub-style callouts: > [!NOTE], > [!WARNING], etc.
  const calloutRegex = /<p>\[!(NOTE|WARNING|TIP|IMPORTANT|CAUTION)\]([\s\S]*?)<\/p>/gi;

  html = html.replace(calloutRegex, (match, type, content) => {
    const calloutType = type.toLowerCase();
    const config = calloutStyles[calloutType] || calloutStyles.note;
    const title = type.charAt(0) + type.slice(1).toLowerCase();
    // return 'test';
    return `<div class="${config.text} mb-2" role="alert">
      ${config.icon} ${title}
      ${content.trim()}
    </div>`;
  });

  return html;
};

const changelogsEntries = await changelogs();
const { limit } = Astro.props;
const entries = limit ? changelogsEntries.slice(0, limit) : changelogsEntries;
---

{
  entries.length > 0 ? (
    entries.map((entry: ChangelogProps) => async () => (
      <li class="display-card--item">
        <div class="display-card--item-meta item-neta--timeline">
          <Bullet class={limit ? 'text-aurora-moss' : 'text-canyon-clay'} />
        </div>
        <div
          class={
            limit
              ? 'display-card--item-content text-white [&_*]:text-white'
              : 'display-card--item-content'
          }
        >
          <h4>{entry.title}</h4>
          <div set:html={await processMarkdown(entry.body)} />
        </div>
      </li>
    ))
  ) : (
    <li class="text-center text-muted-foreground">No changelog entries found.</li>
  )
}
